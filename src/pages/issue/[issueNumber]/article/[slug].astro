---
import { getCollection } from 'astro:content';
import { marked } from 'marked';
import ArticleLayout from '../../../../layouts/ArticleLayout.astro';
import IssueNav from '../../../../components/IssueNav.astro';
import ScreenshotGallery from '../../../../components/ScreenshotGallery.astro';
import RelatedArticles from '../../../../components/RelatedArticles.astro';

export async function getStaticPaths() {
  const issues = await getCollection('issues');

  const paths = issues.flatMap((issue) =>
    issue.data.articles.map((article, index) => ({
      params: {
        issueNumber: String(issue.data.issueNumber),
        slug: String(index),
      },
      props: {
        issue,
        article,
        articleIndex: index,
      },
    }))
  );

  return paths;
}

interface Props {
  issue: Awaited<ReturnType<typeof getCollection<'issues'>>>[number];
  article: Awaited<ReturnType<typeof getCollection<'issues'>>>[number]['data']['articles'][number];
  articleIndex: number;
}

const { issue, article, articleIndex } = Astro.props;
const { issueNumber } = Astro.params;

// å‰å¾Œã®è¨˜äº‹ã‚’å–å¾—
const articles = issue.data.articles;
const prevArticle = articleIndex > 0 ? articles[articleIndex - 1] : null;
const nextArticle = articleIndex < articles.length - 1 ? articles[articleIndex + 1] : null;

// ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ãƒ‡ãƒ¼ã‚¿
const navPrev = prevArticle ? {
  href: `/issue/${issueNumber}/article/${articleIndex - 1}`,
  title: prevArticle.title,
} : undefined;

const navNext = nextArticle ? {
  href: `/issue/${issueNumber}/article/${articleIndex + 1}`,
  title: nextArticle.title,
} : undefined;

const navHome = {
  href: '/',
  title: `Vol.${issueNumber} ãƒˆãƒƒãƒ—ã¸`,
};

// AIç”Ÿæˆã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’HTMLã«å¤‰æ›
let articleContent: string | null = null;
if (article.articleBody) {
  const result = marked.parse(article.articleBody);
  articleContent = typeof result === 'string' ? result : await result;
}

---

<ArticleLayout
  title={article.title}
  category={article.category}
  summary={article.summary}
  game={article.game}
  featureImage={article.featureImage}
  issueNumber={issue.data.issueNumber}
>
  <div class="article-main">
    <div class="article-body">
      {articleContent ? (
        <!-- AIç”Ÿæˆã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒã‚ã‚‹å ´åˆã¯ãã‚Œã‚’è¡¨ç¤º -->
        <div class="generated-content" set:html={articleContent} />
      ) : (
      <!-- ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: å¾“æ¥ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆè¡¨ç¤º -->
      <>
        {article.game ? (
          <section class="game-description">
            <h2>æ¦‚è¦</h2>
            <p>{article.summary}</p>

            {article.category === 'newRelease' && (
              <>
                <h2>ğŸ¯ æ³¨ç›®ãƒã‚¤ãƒ³ãƒˆ</h2>
                <ul>
                  <li>{article.game.developer}ãŒæ‰‹æ›ã‘ã‚‹æœŸå¾…ã®æ–°ä½œ</li>
                  <li>{article.game.genre?.join('ã¨')}ã®è¦ç´ ã‚’çµ„ã¿åˆã‚ã›ãŸæ„æ¬²ä½œ</li>
                  <li>{article.game.platforms?.join('ã€')}ã§ç™ºå£²äºˆå®š</li>
                </ul>

                <h2>âœ¨ ã‚²ãƒ¼ãƒ ã®ç‰¹å¾´</h2>
                <p>
                  {article.game.developer}ãŒé€ã‚Šå‡ºã™æœ¬ä½œã¯ã€
                  {article.game.genre?.join('ã¨')}ã®ã‚¸ãƒ£ãƒ³ãƒ«ã‚’èåˆã•ã›ãŸæ–°ã—ã„ä½“é¨“ã‚’æä¾›ã—ã¾ã™ã€‚
                  æœ€æ–°ãƒãƒ¼ãƒ‰ã®æ€§èƒ½ã‚’æ´»ã‹ã—ãŸã‚°ãƒ©ãƒ•ã‚£ãƒƒã‚¯ã¨ã€
                  ç·´ã‚Šè¾¼ã¾ã‚ŒãŸã‚²ãƒ¼ãƒ ãƒ—ãƒ¬ã‚¤ãŒç‰¹å¾´ã§ã™ã€‚
                </p>

                <h2>ğŸ‘¥ ã“ã‚“ãªäººã«ãŠã™ã™ã‚</h2>
                <ul>
                  <li>{article.game.genre?.[0]}ã‚¸ãƒ£ãƒ³ãƒ«ãŒå¥½ããªæ–¹</li>
                  <li>æ–°ã—ã„ã‚²ãƒ¼ãƒ ä½“é¨“ã‚’æ±‚ã‚ã¦ã„ã‚‹æ–¹</li>
                  <li>{article.game.developer}ã®éå»ä½œå“ã®ãƒ•ã‚¡ãƒ³</li>
                </ul>
              </>
            )}

            {article.category === 'indie' && (
              <>
                <h2>ğŸ¨ é–‹ç™ºã‚¹ãƒˆãƒ¼ãƒªãƒ¼</h2>
                <p>
                  å°è¦æ¨¡é–‹ç™ºãªã‚‰ã§ã¯ã®ç‹¬å‰µçš„ãªã‚¢ã‚¤ãƒ‡ã‚¢ã¨ã€
                  ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å£°ã«è€³ã‚’å‚¾ã‘ãŸä¸å¯§ãªä½œã‚Šè¾¼ã¿ãŒå…‰ã‚‹ä¸€æœ¬ã§ã™ã€‚
                </p>

                <h2>âœ¨ ã‚²ãƒ¼ãƒ ã®é­…åŠ›</h2>
                <ul>
                  <li>ç‹¬è‡ªã®ä¸–ç•Œè¦³ã¨ã‚¢ãƒ¼ãƒˆã‚¹ã‚¿ã‚¤ãƒ«</li>
                  <li>å¿ƒã«æ®‹ã‚‹ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ†ãƒªãƒ³ã‚°</li>
                  <li>ã‚„ã‚Šè¾¼ã¿è¦ç´ ã‚‚å……å®Ÿ</li>
                </ul>

                <h2>ğŸ’¬ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å£°</h2>
                <p>
                  SNSã‚„Steamãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ã¯ã€ŒæœŸå¾…ä»¥ä¸Šã®ä½“é¨“ã ã£ãŸã€
                  ã€Œã‚¤ãƒ³ãƒ‡ã‚£ãƒ¼ã‚²ãƒ¼ãƒ ã®å¯èƒ½æ€§ã‚’æ„Ÿã˜ãŸã€ã¨ã„ã£ãŸå¥½è©•ä¾¡ãŒå¤šæ•°ã€‚
                </p>
              </>
            )}

            {article.category === 'classic' && (
              <>
                <h2>ğŸ“œ ã‚²ãƒ¼ãƒ ã®æ­´å²</h2>
                <p>
                  ç™ºå£²ã‹ã‚‰æ™‚é–“ãŒçµŒã£ãŸä»Šã§ã‚‚å¤šãã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«æ„›ã•ã‚Œç¶šã‘ã‚‹æœ¬ä½œã€‚
                  ãã®å½±éŸ¿åŠ›ã¯å¾Œç¶šã®ä½œå“ã«ã‚‚å¤§ããªå½±éŸ¿ã‚’ä¸ãˆã¦ã„ã¾ã™ã€‚
                </p>

                <h2>ğŸ† åä½œãŸã‚‹ç†ç”±</h2>
                <ul>
                  <li>ç·»å¯†ã«è¨­è¨ˆã•ã‚ŒãŸã‚²ãƒ¼ãƒ ãƒ‡ã‚¶ã‚¤ãƒ³</li>
                  <li>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æŒ‘æˆ¦å¿ƒã‚’åˆºæ¿€ã™ã‚‹çµ¶å¦™ãªé›£æ˜“åº¦</li>
                  <li>ä½•åº¦ã§ã‚‚éŠã³ãŸããªã‚‹ãƒªãƒ—ãƒ¬ã‚¤æ€§</li>
                </ul>
                {article.game.metascore && (
                  <p>
                    Metacriticã§ã¯{article.game.metascore}ç‚¹ã¨ã„ã†é«˜è©•ä¾¡ã‚’ç²å¾—ã—ã¦ãŠã‚Šã€
                    æ‰¹è©•å®¶ã‹ã‚‰ã‚‚é«˜ã„æ”¯æŒã‚’å¾—ã¦ã„ã¾ã™ã€‚
                  </p>
                )}

                <h2>ğŸ® ä»Šãƒ—ãƒ¬ã‚¤ã™ã‚‹ä¾¡å€¤</h2>
                <p>
                  ç¾ä»£ã®ã‚²ãƒ¼ãƒ ã«ã¯ãªã„å‘³ã‚ã„ãŒã‚ã‚Šã€
                  ã‚²ãƒ¼ãƒ ã®æœ¬è³ªçš„ãªæ¥½ã—ã•ã‚’å†ç™ºè¦‹ã§ãã¾ã™ã€‚
                </p>

                <h2>ğŸ‘¥ ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£æƒ…å ±</h2>
                <p>
                  ä»Šã§ã‚‚æ´»ç™ºãªãƒ•ã‚¡ãƒ³ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ãŒå­˜åœ¨ã—ã€
                  MODã‚„æ”»ç•¥æƒ…å ±ãŒè±Šå¯Œã«å…±æœ‰ã•ã‚Œã¦ã„ã¾ã™ã€‚
                </p>
              </>
            )}
          </section>
        ) : (
          <section class="feature-content">
            <h2>ğŸ“° ç‰¹é›†</h2>
            <p>{article.summary}</p>

            <h2>ğŸ® ãŠã™ã™ã‚ã‚²ãƒ¼ãƒ </h2>
            <p>
              ã“ã®ç‰¹é›†ã§ã¯ã€ãƒ†ãƒ¼ãƒã«æ²¿ã£ãŸãŠã™ã™ã‚ã‚¿ã‚¤ãƒˆãƒ«ã‚„ã€
              æ¥½ã—ã¿æ–¹ã®ãƒ’ãƒ³ãƒˆã‚’ãŠå±Šã‘ã—ã¾ã™ã€‚
            </p>

            <h2>ğŸ’¡ é¸ã³æ–¹ã®ãƒã‚¤ãƒ³ãƒˆ</h2>
            <p>
              è‡ªåˆ†ã®ãƒ—ãƒ¬ã‚¤ã‚¹ã‚¿ã‚¤ãƒ«ã‚„å¥½ã¿ã«åˆã‚ã›ã¦ã€
              ã´ã£ãŸã‚Šã®ã‚²ãƒ¼ãƒ ã‚’è¦‹ã¤ã‘ã¦ãã ã•ã„ã€‚
            </p>
          </section>
        )}
      </>
    )}
    </div>
  </div>

  {article.game?.screenshots && article.game.screenshots.length > 0 && (
    <ScreenshotGallery
      screenshots={article.game.screenshots}
      gameTitle={article.game.title}
    />
  )}

  <RelatedArticles
    articles={articles}
    currentIndex={articleIndex}
    issueNumber={issue.data.issueNumber}
    category={article.category}
  />

  <IssueNav prev={navPrev} next={navNext} home={navHome} />
</ArticleLayout>

<style>
  .article-main {
    background: var(--color-surface);
    border-radius: var(--radius-md);
    padding: var(--spacing-md);
    box-shadow: var(--shadow-md);
    margin-bottom: var(--spacing-md);
  }

  .article-body {
    margin-bottom: 0;
    columns: 2;
    column-gap: var(--spacing-xl);
  }

  /* 2ã‚«ãƒ©ãƒ ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆæ™‚ã«h2ã§æ”¹è¡Œã•ã‚Œãªã„ã‚ˆã†ã«ã™ã‚‹ */
  .article-body :global(h2) {
    break-after: avoid;
  }

  /* AIç”Ÿæˆã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚° */
  .generated-content :global(h2) {
    font-size: 1.3rem;
    color: var(--color-primary);
    margin-top: var(--spacing-lg);
    margin-bottom: var(--spacing-sm);
    padding-bottom: var(--spacing-xs);
    border-bottom: 2px solid var(--color-border);
  }

  .generated-content :global(h2:first-child) {
    margin-top: 0;
  }

  .generated-content :global(h3) {
    font-size: 1.1rem;
    color: var(--color-text);
    margin-top: var(--spacing-md);
    margin-bottom: var(--spacing-xs);
  }

  .generated-content :global(p) {
    line-height: 1.75;
    margin-bottom: var(--spacing-md);
    font-size: 0.95rem;
  }

  .generated-content :global(ul),
  .generated-content :global(ol) {
    margin-bottom: var(--spacing-md);
    padding-left: var(--spacing-lg);
  }

  .generated-content :global(li) {
    line-height: 1.7;
    margin-bottom: var(--spacing-xs);
    position: relative;
    font-size: 0.95rem;
  }

  .generated-content :global(ul li::marker) {
    color: var(--color-primary);
  }

  .generated-content :global(strong) {
    color: var(--color-primary);
    font-weight: 600;
  }

  .generated-content :global(blockquote) {
    border-left: 3px solid var(--color-primary);
    padding: var(--spacing-sm) var(--spacing-md);
    margin: var(--spacing-md) 0;
    background: rgba(233, 69, 96, 0.1);
    border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
  }

  /* ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ã‚¹ã‚¿ã‚¤ãƒ« */
  .game-description h2,
  .feature-content h2 {
    font-size: 1.3rem;
    color: var(--color-primary);
    margin-top: var(--spacing-lg);
    margin-bottom: var(--spacing-sm);
  }

  .game-description h2:first-child,
  .feature-content h2:first-child {
    margin-top: 0;
  }

  .game-description p,
  .feature-content p {
    line-height: 1.75;
    margin-bottom: var(--spacing-sm);
    font-size: 0.95rem;
  }

  .game-description ul {
    margin-bottom: var(--spacing-md);
    padding-left: var(--spacing-lg);
  }

  .game-description li {
    line-height: 1.7;
    margin-bottom: var(--spacing-xs);
    font-size: 0.95rem;
  }

  @media (max-width: 1024px) {
    .article-body {
      columns: 1;
    }
  }
</style>
