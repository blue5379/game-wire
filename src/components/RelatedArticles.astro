---
interface Article {
  title: string;
  category: 'newRelease' | 'indie' | 'feature' | 'classic';
  summary: string;
  coverImage?: string;
  game?: {
    title: string;
    coverImage?: string;
  };
}

interface Props {
  articles: Article[];
  currentIndex: number;
  issueNumber: number;
  category: 'newRelease' | 'indie' | 'feature' | 'classic';
}

const { articles, currentIndex, issueNumber, category } = Astro.props;

// 同じカテゴリの記事をフィルタリング（現在の記事を除く）
const relatedArticles = articles
  .map((article, index) => ({ ...article, index }))
  .filter((article) => article.category === category && article.index !== currentIndex)
  .slice(0, 3);

const categoryLabels: Record<string, string> = {
  newRelease: '新作紹介',
  indie: 'インディーゲーム',
  feature: '特集',
  classic: '名作深掘り',
};
---

{relatedArticles.length > 0 && (
  <section class="related-articles">
    <h3 class="related-title">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20" />
        <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z" />
      </svg>
      {categoryLabels[category]}の他の記事
    </h3>
    <div class="related-grid">
      {relatedArticles.map((article) => (
        <a
          href={`/issue/${issueNumber}/article/${article.index}`}
          class="related-card"
        >
          <div class="related-image">
            {(article.coverImage || article.game?.coverImage) ? (
              <img
                src={article.coverImage || article.game?.coverImage}
                alt={article.title}
                loading="lazy"
              />
            ) : (
              <div class="related-placeholder">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                  <rect x="2" y="6" width="20" height="12" rx="2" />
                  <path d="M6 12h4m-2-2v4" />
                  <circle cx="17" cy="10" r="1" />
                  <circle cx="15" cy="14" r="1" />
                </svg>
              </div>
            )}
          </div>
          <div class="related-content">
            <h4 class="related-card-title">{article.title}</h4>
            <p class="related-summary">{article.summary}</p>
          </div>
        </a>
      ))}
    </div>
  </section>
)}

<style>
  .related-articles {
    margin-top: var(--spacing-2xl);
    padding-top: var(--spacing-xl);
    border-top: 1px solid var(--color-border);
  }

  .related-title {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    font-size: 1.25rem;
    color: var(--color-text);
    margin-bottom: var(--spacing-lg);
  }

  .related-title svg {
    width: 24px;
    height: 24px;
    color: var(--color-primary);
  }

  .related-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: var(--spacing-md);
  }

  .related-card {
    display: flex;
    gap: var(--spacing-md);
    padding: var(--spacing-md);
    background: var(--color-surface);
    border-radius: var(--radius-md);
    border: 1px solid var(--color-border);
    text-decoration: none;
    color: inherit;
    transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
  }

  .related-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
    border-color: var(--color-primary);
  }

  .related-image {
    flex-shrink: 0;
    width: 100px;
    height: 75px;
    border-radius: var(--radius-sm);
    overflow: hidden;
    background: var(--color-accent);
  }

  .related-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .related-placeholder {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, var(--color-secondary) 0%, var(--color-accent) 100%);
  }

  .related-placeholder svg {
    width: 32px;
    height: 32px;
    color: rgba(255, 255, 255, 0.5);
  }

  .related-content {
    flex: 1;
    min-width: 0;
  }

  .related-card-title {
    font-size: 0.95rem;
    font-weight: 600;
    line-height: 1.4;
    margin-bottom: var(--spacing-xs);
    color: var(--color-text);
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    transition: color 0.2s ease;
  }

  .related-card:hover .related-card-title {
    color: var(--color-primary);
  }

  .related-summary {
    font-size: 0.8rem;
    color: var(--color-text-muted);
    line-height: 1.5;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    margin: 0;
  }

  /* モバイル対応 */
  @media (max-width: 640px) {
    .related-grid {
      grid-template-columns: 1fr;
    }

    .related-card {
      flex-direction: column;
    }

    .related-image {
      width: 100%;
      height: 120px;
    }
  }
</style>
