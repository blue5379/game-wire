# Game Wire é€±åˆŠãƒ“ãƒ«ãƒ‰ãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# æ¯Žé€±æ—¥æ›œæ—¥ AM 9:00 (JST) ã«è‡ªå‹•å®Ÿè¡Œ

name: Weekly Build and Deploy

on:
  # å®šæœŸå®Ÿè¡Œ: æ¯Žæ—¥ PM 14:00 JST (= UTC 5:00) - ãƒ†ã‚¹ãƒˆç”¨
  # TODO: ãƒ†ã‚¹ãƒˆå¾Œã€æœ¬ç•ªæ™‚é–“ (JST 9:20 = cron '20 0 * * 0') ã«æˆ»ã™
  schedule:
    - cron: '0 5 * * *'

  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:
    inputs:
      publish_date:
        description: 'ç™ºè¡Œæ—¥ (YYYY-MM-DDå½¢å¼ã€ç©ºæ¬„ã§å½“æ—¥)'
        required: false
        type: string

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      # 1. ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Node.js ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # 3. ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - name: Install dependencies
        run: npm ci

      # 4. ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼ˆSteam, YouTube, IGDB, Metacriticï¼‰
      - name: Fetch game data
        run: npm run fetch-data
        env:
          YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
          IGDB_CLIENT_ID: ${{ secrets.IGDB_CLIENT_ID }}
          IGDB_CLIENT_SECRET: ${{ secrets.IGDB_CLIENT_SECRET }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}

      # 5. è¨˜äº‹ç”Ÿæˆï¼ˆBedrock Claude + ç”»åƒç”Ÿæˆï¼‰
      - name: Generate articles
        run: npm run generate
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          PUBLISH_DATE: ${{ inputs.publish_date }}

      # 6. å·ã‚’çµ„ã¿ç«‹ã¦
      - name: Build issue
        run: npx tsx scripts/build-issue.ts

      # 7. Astro ãƒ“ãƒ«ãƒ‰
      - name: Build Astro site
        run: npm run build

      # 8. Cloudflare Pages ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆï¼ˆå­˜åœ¨ã—ãªã„å ´åˆï¼‰
      - name: Create Cloudflare Pages project
        uses: cloudflare/wrangler-action@v3
        continue-on-error: true
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages project create game-wire --production-branch main

      # 9. Cloudflare Pages ã«ãƒ‡ãƒ—ãƒ­ã‚¤
      - name: Deploy to Cloudflare Pages
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy dist --project-name=game-wire --commit-dirty=true

      # 10. å®Œäº†é€šçŸ¥ï¼ˆã‚µãƒžãƒªãƒ¼ï¼‰
      - name: Build summary
        run: |
          echo "## ðŸŽ® Game Wire Build Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Date**: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- **Publish Date**: ${{ inputs.publish_date || 'Today' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: Deployed to Cloudflare Pages" >> $GITHUB_STEP_SUMMARY
